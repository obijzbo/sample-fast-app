pipeline {
    agent any

    environment {
        APP_IMAGE_NAME = "nahiyanswe/simple-fast-app"
        KUBE_CONFIG_ID = "Kube-Config"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', credentialsId: 'Git-Hub-Auth', url: 'https://github.com/obijzbo/sample-fast-app'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Build Docker images
                    dockerBuildImage(APP_IMAGE_NAME)
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    // Push Docker images to Docker Hub
                    dockerPushImage(APP_IMAGE_NAME)
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    // Deploy to Kubernetes
                    deployToKubernetes()
                }
            }
        }

        stage('Cleanup') {
            steps {
                script {
                    // Remove Docker images
                    dockerRemoveImage(APP_IMAGE_NAME)
                    deleteDir()
                }
            }
        }
    }
}

// Custom functions for improved readability and reusability

def dockerBuildImage(imageName) {
    def image = docker.build imageName
}

def dockerPushImage(imageName) {
    docker.withRegistry('https://registry.hub.docker.com', 'Docker-Hub-Auth') {
        def image = docker.image(imageName)
        image.push()
    }
}

def dockerRemoveImage(imageName) {
    sh "docker rmi $imageName"
}

def deployToKubernetes() {
    kubeconfig(credentialsId: env.KUBE_CONFIG_ID, serverUrl: '192.168.56.20') {
        sh '/usr/local/bin/kubectl apply -f sample-fast-app.yml'
    }
}